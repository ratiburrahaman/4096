var a,b={tileSize:200,tweenSpeed:50,tileSpacing:20,localStorageName:"top4096score"},c=0,d=1;window.onload=function(){var c={type:Phaser.CANVAS,width:4*b.tileSize+5*b.tileSpacing,height:(4*b.tileSize+5*b.tileSpacing)*16/9,backgroundColor:15528177,scene:[e,f]};a=new Phaser.Game(c),window.focus(),g(),window.addEventListener("resize",g,!1)};var e=new Phaser.Class({Extends:Phaser.Scene,initialize:function(){Phaser.Scene.call(this,{key:"PreloadAssets"})},preload:function(){this.load.image("spot","assets/sprites/spot.png"),this.load.image("gametitle","assets/sprites/gametitle.png"),this.load.image("restart","assets/sprites/restart.png"),this.load.image("scorepanel","assets/sprites/scorepanel.png"),this.load.image("scorelabels","assets/sprites/scorelabels.png"),this.load.image("logo","assets/sprites/logo.png"),this.load.image("howtoplay","assets/sprites/howtoplay.png"),this.load.spritesheet("tiles","assets/sprites/tiles.png",{frameWidth:b.tileSize,frameHeight:b.tileSize}),this.load.bitmapFont("font","assets/fonts/font.png","assets/fonts/font.fnt"),this.load.audio("move",["assets/sounds/move.ogg","assets/sounds/move.mp3"]),this.load.audio("grow",["assets/sounds/grow.ogg","assets/sounds/grow.mp3"])},create:function(){this.scene.start("PlayGame")}}),f=new Phaser.Class({Extends:Phaser.Scene,initialize:function(){Phaser.Scene.call(this,{key:"PlayGame"})},create:function(){this.fieldArray=[],this.fieldGroup=this.add.group(),this.score=0,this.bestScore=null==localStorage.getItem(b.localStorageName)?0:localStorage.getItem(b.localStorageName);for(var e=0;e<4;e++){this.fieldArray[e]=[];for(var f=0;f<4;f++){this.add.sprite(this.tileDestination(f,d),this.tileDestination(e,c),"spot");var g=this.add.sprite(this.tileDestination(f,d),this.tileDestination(e,c),"tiles");g.alpha=0,g.visible=0,this.fieldGroup.add(g),this.fieldArray[e][f]={tileValue:0,tileSprite:g,canUpgrade:!0}}}var h=this.add.sprite(this.tileDestination(3,d),this.tileDestination(0,c)-200,"restart");h.setInteractive(),h.on("pointerdown",function(){this.scene.start("PlayGame")},this),this.add.sprite(this.tileDestination(1,d),this.tileDestination(0,c)-200,"scorepanel"),this.add.sprite(this.tileDestination(1,d),this.tileDestination(0,c)-270,"scorelabels"),this.add.sprite(10,5,"gametitle").setOrigin(0,0),this.add.sprite(a.config.width,5,"howtoplay").setOrigin(1,0),this.scoreText=this.add.bitmapText(this.tileDestination(0,d)-80,this.tileDestination(0,c)-225,"font","0"),this.bestScoreText=this.add.bitmapText(this.tileDestination(2,d)-190,this.tileDestination(0,c)-225,"font",this.bestScore.toString()),this.input.keyboard.on("keydown",this.handleKey,this),this.canMove=!1,this.addTile(),this.addTile(),this.input.on("pointerup",this.endSwipe,this),this.moveSound=this.sound.add("move"),this.growSound=this.sound.add("grow")},endSwipe:function(d){var h=d.upTime-d.downTime,f=new Phaser.Geom.Point(d.upX-d.downX,d.upY-d.downY),g=Phaser.Geom.Point.GetMagnitude(f),e=new Phaser.Geom.Point(f.x/g,f.y/g);if(g>20&&h<1e3&&(Math.abs(e.y)>.8||Math.abs(e.x)>.8)){var c=this.fieldGroup.getChildren();if(e.x>.8){for(var b=0;b<c.length;b++)c[b].depth=a.config.width-c[b].x;this.handleMove(0,1)}if(e.x< -0.8){for(var b=0;b<c.length;b++)c[b].depth=c[b].x;this.handleMove(0,-1)}if(e.y>.8){for(var b=0;b<c.length;b++)c[b].depth=a.config.height-c[b].y;this.handleMove(1,0)}if(e.y< -0.8){for(var b=0;b<c.length;b++)c[b].depth=c[b].y;this.handleMove(-1,0)}}},addTile:function(){for(var e=[],c=0;c<4;c++)for(var d=0;d<4;d++)0==this.fieldArray[c][d].tileValue&&e.push({row:c,col:d});if(e.length>0){var a=Phaser.Utils.Array.GetRandom(e);this.fieldArray[a.row][a.col].tileValue=1,this.fieldArray[a.row][a.col].tileSprite.visible=!0,this.fieldArray[a.row][a.col].tileSprite.setFrame(0),this.tweens.add({targets:[this.fieldArray[a.row][a.col].tileSprite],alpha:1,duration:b.tweenSpeed,onComplete:function(a){a.parent.scene.canMove=!0}})}},handleKey:function(d){if(this.canMove){var c=this.fieldGroup.getChildren();switch(d.code){case"KeyA":case"ArrowLeft":for(var b=0;b<c.length;b++)c[b].depth=c[b].x;this.handleMove(0,-1);break;case"KeyD":case"ArrowRight":for(var b=0;b<c.length;b++)c[b].depth=a.config.width-c[b].x;this.handleMove(0,1);break;case"KeyW":case"ArrowUp":for(var b=0;b<c.length;b++)c[b].depth=c[b].y;this.handleMove(-1,0);break;case"KeyS":case"ArrowDown":for(var b=0;b<c.length;b++)c[b].depth=a.config.height-c[b].y;this.handleMove(1,0)}}},handleMove:function(f,g){this.canMove=!1;var k=!1;this.movingTiles=0;for(var l=0,h=0;h<4;h++)for(var i=0;i<4;i++){var a=1==g?3-i:i,c=1==f?3-h:h,j=this.fieldArray[c][a].tileValue;if(0!=j){for(var d=g,e=f;this.isInsideBoard(c+e,a+d)&&0==this.fieldArray[c+e][a+d].tileValue;)d+=g,e+=f;this.isInsideBoard(c+e,a+d)&&this.fieldArray[c+e][a+d].tileValue==j&&this.fieldArray[c+e][a+d].canUpgrade&&this.fieldArray[c][a].canUpgrade&&j<12?(this.fieldArray[c+e][a+d].tileValue++,l+=Math.pow(2,this.fieldArray[c+e][a+d].tileValue),this.fieldArray[c+e][a+d].canUpgrade=!1,this.fieldArray[c][a].tileValue=0,this.moveTile(this.fieldArray[c][a],c+e,a+d,Math.abs(e+d),!0),k=!0):(d-=g,e-=f,(0!=d||0!=e)&&(this.fieldArray[c+e][a+d].tileValue=j,this.fieldArray[c][a].tileValue=0,this.moveTile(this.fieldArray[c][a],c+e,a+d,Math.abs(e+d),!1),k=!0))}}k?(this.moveSound.play(),this.score+=l,this.score>this.bestScore&&(this.bestScore=this.score,localStorage.setItem(b.localStorageName,this.bestScore))):this.canMove=!0},moveTile:function(a,e,f,g,h){this.movingTiles++,this.tweens.add({targets:[a.tileSprite],x:this.tileDestination(f,d),y:this.tileDestination(e,c),duration:b.tweenSpeed*g,onComplete:function(b){b.parent.scene.movingTiles--,h&&b.parent.scene.transformTile(a,e,f),0==b.parent.scene.movingTiles&&(b.parent.scene.scoreText.text=b.parent.scene.score.toString(),b.parent.scene.bestScoreText.text=b.parent.scene.bestScore.toString(),b.parent.scene.resetTiles(),b.parent.scene.addTile())}})},transformTile:function(a,c,d){this.growSound.play(),this.movingTiles++,a.tileSprite.setFrame(this.fieldArray[c][d].tileValue-1),this.tweens.add({targets:[a.tileSprite],scaleX:1.1,scaleY:1.1,duration:b.tweenSpeed,yoyo:!0,repeat:1,onComplete:function(a){a.parent.scene.movingTiles--,0==a.parent.scene.movingTiles&&(a.parent.scene.scoreText.text=a.parent.scene.score.toString(),a.parent.scene.bestScoreText.text=a.parent.scene.bestScore.toString(),a.parent.scene.resetTiles(),a.parent.scene.addTile())}})},resetTiles:function(){for(var a=0;a<4;a++)for(var b=0;b<4;b++)this.fieldArray[a][b].canUpgrade=!0,this.fieldArray[a][b].tileSprite.x=this.tileDestination(b,d),this.fieldArray[a][b].tileSprite.y=this.tileDestination(a,c),this.fieldArray[a][b].tileValue>0?(this.fieldArray[a][b].tileSprite.alpha=1,this.fieldArray[a][b].tileSprite.visible=!0,this.fieldArray[a][b].tileSprite.setFrame(this.fieldArray[a][b].tileValue-1)):(this.fieldArray[a][b].tileSprite.alpha=0,this.fieldArray[a][b].tileSprite.visible=!1)},isInsideBoard:function(a,b){return a>=0&&b>=0&&a<4&&b<4},tileDestination:function(d,e){var f=e==c?(a.config.height-a.config.width)/2:0;return d*(b.tileSize+b.tileSpacing)+b.tileSize/2+b.tileSpacing+f}});function g(){var b=document.querySelector("canvas"),c=window.innerWidth,d=window.innerHeight,e=a.config.width/a.config.height;c/d<e?(b.style.width=c+"px",b.style.height=c/e+"px"):(b.style.width=d*e+"px",b.style.height=d+"px")}